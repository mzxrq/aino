<!-- .github/copilot-instructions.md - Project-specific guidance for AI coding agents -->

# Stock Dashboard — AI Agent Instructions

This guide provides essential knowledge to be immediately productive in this multi-service stock market anomaly detection dashboard.

## Architecture Overview

Three-service architecture with single public port (5050):

**backend-node/** (Express, port 5050)
- Gateway service: routes starting with `/node/*`
- Proxies Python service (no proxy prefix needed - Python handles `/py/*` internally)
- **Resilient DB pattern**: Falls back to JSON files (`src/cache/users.json`, `src/cache/subscriptions.json`) when MongoDB unavailable
- Entry: `src/server.js`, routes in `src/routes/`, middleware in `src/middleware/`

**backend-python/** (FastAPI, port 5000)
- Chart data pipeline: yfinance → pandas preprocessing → anomaly detection (IsolationForest)
- Scheduler: background thread for market-aware anomaly detection + LINE notifications
- Entry: `app/main.py`, API routes in `app/api/`, business logic in `app/services/`
- Models: lazy-loaded from `app/models/*.pkl` (no startup failure if missing)

**frontend-react/** (Vite + React, port 5173)
- Charts: Apache ECharts 6.0 for OHLC candlesticks, volume bars, technical indicators (VWAP, Bollinger Bands, RSI)
- Timezone system: 50 zones with Luxon for offset calculations, live time display, formatLabel pattern
- Auth: JWT context in `src/context/AuthContext.jsx`, normalized user object pattern
- Entry: `src/main.jsx`, pages in `src/pages/`, reusable components in `src/components/`

**Data Flow:**
Frontend → Node (5050) → Python (5000 proxied) → yfinance → preprocessing → anomaly detection → MongoDB cache → LINE notifications

## Quick Start (PowerShell)

```powershell
# Node backend
cd backend-node; npm install; npm start  # port 5050
cd backend-node\src; node server.js;

# Python backend
cd backend-python; pip install -r requirements.txt
cd app; python -m uvicorn main:app --reload --port 5000

# Frontend
cd frontend-react\src; npm install; npm run dev  # port 5173
```

**Environment Notes:**
- Node reads `.env` (root `.env`)
- Python reads `.env` (root `.env`)
- Frontend reads `.env` (frontend-react/.env)
- Frontend uses `VITE_API_URL` (Node gateway) and `VITE_LINE_PY_URL` (Python for LINE auth)
- Docker: Use `docker-compose.yml` for full stack (includes MongoDB)

## Project-Specific Patterns (MUST FOLLOW)

### 1. Authentication Flow
- JWT shared across services, generated by Python `/py/auth/line/callback` on LINE OAuth
- Node middleware: `optionalAuthenticate` (extract userId, no fail) vs `requireAuth` (full auth + DB user load)
- Frontend: `AuthContext` normalizes user objects (`_id`/`id`/`userId` → `id`, timestamps → ISO strings)
- Token storage: localStorage, sent as `Authorization: Bearer <token>`
- Example: `backend-node/src/middleware/authMiddleware.js` lines 14-36 (optionalAuthenticate pattern)

### 2. MongoDB Fallback Cache (Node ONLY)
- Pattern: Try MongoDB first, catch errors → read/write JSON files in `src/cache/`
- Files: `users.json`, `subscriptions.json` (already exist, preserve this structure)
- Why: Allows development/testing without running MongoDB
- Example: `backend-node/src/services/usersService.js` - readUsersFile/writeUsersFile helpers
- **Rule**: When adding Node services, replicate this dual-mode pattern

### 3. Chart Data Contract
- Python builds payload in `app/api/chart.py` with keys:
  - Arrays: `dates` (ISO8601 with timezone offset), `open`, `high`, `low`, `close`, `volume`, `VWAP`, `bollinger_bands.upper/lower/sma`, `RSI`
  - Anomaly objects: `anomaly_markers` array with `{ date, y }` structure
  - Metadata: `Ticker`, `companyName`, `market` (formatted like "US (NASDAQ)")
- Frontend expects exact key names in `Chart.jsx` (line 200+) and `FinancialChartEcharts.jsx`
- **ISO8601 requirement**: Use `datetime.isoformat()` (includes colon in offset) - frontend has defensive `normalizeIso` if needed
- Caching: MongoDB `cache` collection with TTL, key pattern `chart::{ticker}::{period}::{interval}`

### 4. Portal Dropdown Pattern
- Component: `frontend-react/src/components/PortalDropdown.jsx`
- Purpose: Renders dropdown outside parent stacking context (fixes overflow/z-index issues)
- Usage: Pass `anchorRect` (from `buttonRef.current.getBoundingClientRect()`), `align`, `offsetY`
- Example: `TimezoneSelect.jsx` lines 50-65 - timezone dropdown implementation
- **When to use**: Any dropdown inside fixed/overflow containers or complex layouts

### 5. Timezone Display System
- 50 timezones (full-hour offsets only), defined in `Chart.jsx` lines 15-62
- Functions:
  - `formatTimezoneLabel()`: Converts to "(±HH:MM) CityName" format (lines 72-92)
  - `getTimezoneOffset()`: Calculates UTC offset hours via Luxon (lines 95-105)
  - `sortTimezonesByOffset()`: Sorts UTC-12 to UTC+14 (lines 108-111)
  - `getTimezoneTimeString()`: Live time "HH:MM:SS UTC±HH" with 1-second updates (lines 114-128)
- Component: `TimezoneSelect.jsx` accepts `formatLabel`, `sortFn`, `displayTime` props
- Mobile: Shows globe icon when time text hidden (CSS media query 600px)

### 6. Anomaly Visualization (ECharts)
- Component: `FinancialChartEcharts.jsx` (348 lines)
- Features: Red triangle markers (markPoint) + semi-transparent red vertical bands (markArea)
- Data: `anomalies` prop as `[{ date, y }]`, optional `anomalyIndices` for ordinal x-axis
- Toggle: `showAnomaly` boolean controls visibility
- Implementation: Lines 91-120 build markPointData and markAreaData, lines 127-148 add to series
- Color: `rgba(220, 53, 69, 0.15)` for bands, `#dc3545` for markers

## API Routes Reference

**Node (`/node/*`):**
- `/node/users` - User CRUD (uses MongoDB or JSON fallback)
- `/node/subscribers` - Subscriber management (ticker subscriptions)
- `/node/marketlists` - Market instrument metadata
- `/node/cache` - Direct cache access (chart payloads)
- `/node/mail` - Email sending via mailService
- Health: `GET /health`

**Python (`/py/*`):**
- `GET/POST /py/chart` - Chart data for single/multiple tickers (query: ticker, period, interval)
- `GET /py/chart/ticker?query=AAPL` - Ticker search (returns ticker + company name)
- `GET /py/financials?ticker=AAPL` - yfinance fundamentals (balance_sheet, financials, earnings, news)
- `POST /py/auth/line/callback` - LINE OAuth exchange (returns user + JWT)
- `GET /py/profile` - Current user profile (requires auth header)
- `POST /py/scheduler/toggle` - Enable/disable background anomaly detection
- Health: `GET /py/health`

## Key Files for Debugging

**When charts are broken:**
- `backend-python/app/api/chart.py` (payload construction, cache helpers)
- `frontend-react/src/pages/Chart.jsx` (data fetching, PRESETS, toolbar state)
- `frontend-react/src/components/FinancialChartEcharts.jsx` (ECharts option building)
- Check: ISO date formats, `dates` array not empty, anomaly data structure

**When auth fails:**
- `backend-node/src/middleware/authMiddleware.js` (JWT verification, user loading)
- `backend-python/app/api/auth.py` (LINE callback, token generation)
- `frontend-react/src/context/AuthContext.jsx` (normalizeUser pattern, token storage)
- Check: JWT_SECRET matches across services, token in localStorage, Authorization header format

**When dropdowns clip/misalign:**
- `frontend-react/src/components/PortalDropdown.jsx` (viewport-aware positioning)
- `frontend-react/src/components/TimezoneSelect.jsx` (timezone dropdown usage example)
- Check: anchorRect calculation, z-index conflicts, responsive CSS media queries

**When DB operations fail:**
- `backend-node/src/config/db.js` (MongoDB connection, singleton pattern)
- `backend-python/app/core/config.py` (Python Mongo client, env loading)
- `backend-node/src/services/usersService.js` (fallback JSON file pattern)
- Check: MONGO_URI env var, connection timeout, fallback file paths

## Testing & Validation

**Quick Health Checks:**
```powershell
# Node gateway
Invoke-RestMethod http://localhost:5050/health

# Python service
Invoke-RestMethod http://localhost:8000/py/health

# Chart data (single ticker)
Invoke-RestMethod "http://localhost:8000/py/chart?ticker=AAPL&period=1d&interval=1m"
```

**Common Issues:**
- Blank charts: Check browser console for ISO date parsing errors, verify `dates` array in payload
- CORS errors: Add frontend origin to `backend-python/app/main.py` origins list (line 22)
- 401 on protected routes: Verify JWT_SECRET_KEY matches in Node and Python `.env` files
- Dropdown renders left: Check viewport bounds in PortalDropdown, use `align="right"` prop
- Timezone not visible on mobile: Verify CSS media query at 600px shows `.timezone-icon`

## Code Style & Conventions

**JavaScript/JSX:**
- Use arrow functions for components and helpers
- PropTypes or TypeScript not enforced (but document complex props in comments)
- CSS: Separate files per page/component in `src/css/`, BEM-like naming (e.g., `toolbar-period-btn`)
- Responsive: Mobile-first breakpoints at 768px, 600px, 480px

**Python:**
- FastAPI router pattern: Create router in `app/api/*.py`, register in `main.py`
- Services: Pure functions in `app/services/*.py`, import shared `db` from `core.config`
- Logging: Use `logger` from `core.config`, not print statements
- Type hints: Use Pydantic models for request/response schemas

**MongoDB:**
- Collections: `users`, `subscribers`, `anomalies`, `marketlists`, `tickermeta`, `cache`
- Schema: See `docs/specs/database-schema.md` for field definitions
- Cache pattern: TTL-based with `fetched_at` timestamp, keys like `chart::{ticker}::{period}::{interval}`

## Extending the Codebase

**Adding a new chart indicator:**
1. Python: Calculate in `data_preprocessing()` in `services/train_service.py`
2. Python: Add to payload dict in `chart.py` (preserve existing keys)
3. Frontend: Add toggle state in `Chart.jsx`, pass as prop to `FinancialChartEcharts.jsx`
4. Frontend: Build series in `useMemo` option (lines 155-205 in FinancialChartEcharts.jsx)

**Adding a new Node endpoint:**
1. Create route file in `backend-node/src/routes/`
2. Create controller in `backend-node/src/controllers/`
3. Create service with MongoDB + JSON fallback in `backend-node/src/services/`
4. Register route in `server.js` (e.g., `app.use('/node/newroute', newRoutes)`)

**Adding a new frontend page:**
1. Create component in `frontend-react/src/pages/`
2. Add route in `App.jsx` (use React Router)
3. Add navigation link in `Navbar.jsx`
4. Create CSS file in `src/css/` if needed

FEATURE DOCUMENTATION:
- Check `docs/specs/` for technical specifications
- All documentation includes timestamps in JST (UTC+9 Osaka time)

BEFORE implementing features:
- Read related docs in `docs/specs/` for context
- Check `docs/features/` for similar implementations
- Verify API contracts in `docs/specs/API.md`
- Check database schema in `docs/specs/database-schema.md`

AFTER implementing features:
- Document API changes in `docs/specs/API.md`

---

**For clarification or examples on specific patterns, reference the file paths and line numbers provided above.**
---
