version: "3.9"

services:
  mongo:
    image: mongo:6
    container_name: stock_mongo
    ports:
      - "27017:27017"
    volumes:
      - mongo_data:/data/db
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.runCommand({ ping: 1 })"]
      interval: 30s
      timeout: 10s
      retries: 5

  backend-node:
    build:
      context: .
      dockerfile: backend-node/Dockerfile
    container_name: stock_node
    environment:
      - NODE_ENV=production
      - PORT=5050
      - MONGO_CONNECTION_STRING=mongodb://mongo:27017
      - DB_NAME=stock_anomaly_db
      - NODE_SERVICE_TOKEN=${NODE_SERVICE_TOKEN}
    ports:
      - "5050:5050"
    depends_on:
      mongo:
        condition: service_healthy

  backend-python:
    build:
      context: .
      dockerfile: backend-python/Dockerfile
    container_name: stock_python
    environment:
      - PORT=5000
      - MONGO_CONNECTION_STRING=mongodb://mongo:27017
      - DB_NAME=stock_anomaly_db
      - LINE_CLIENT_ID=${LINE_CLIENT_ID}
      - LINE_CLIENT_SECRET=${LINE_CLIENT_SECRET}
      - LINE_REDIRECT_URI=${LINE_REDIRECT_URI}
      - SECRET_KEY=${SECRET_KEY}
      - ALGORITHM=HS256
      - ACCESS_TOKEN_EXPIRE_MINUTES=10080
      - NODE_API_URL=http://backend-node:5050
      - NODE_SERVICE_TOKEN=${NODE_SERVICE_TOKEN}
    ports:
      - "5000:5000"
    depends_on:
      mongo:
        condition: service_healthy

  frontend:
    build:
      context: .
      dockerfile: frontend-react/Dockerfile
      args:
        VITE_API_URL: http://backend-node:5050
        VITE_LINE_PY_URL: http://backend-python:5000
        VITE_LINE_CLIENT_ID: ${LINE_CLIENT_ID}
        VITE_LINE_REDIRECT_URI: ${LINE_REDIRECT_URI}
    container_name: stock_frontend
    ports:
      - "8080:80"
    depends_on:
      backend-node:
        condition: service_started
      backend-python:
        condition: service_started

volumes:
  mongo_data:
    driver: local
